<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>年薪60W分水岭：基于Netty手写实现Dubbo框架 | Mic带你学架构</title><meta name="keywords" content="RPC,Dubbo,Netty手写RPC"><meta name="author" content="Mic带你学架构"><meta name="copyright" content="Mic带你学架构"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="阅读这篇文章之前，建议先阅读和这篇文章关联的内容。  1. 详细剖析分布式微服务架构下网络通信的底层实现原理（图解） 2. (年薪60W的技巧)工作了5年，你真的理解Netty以及为什么要用吗？（深度干货） 3. 深度解析Netty中的核心组件（图解+实例） 4. BAT面试必问细节：关于Netty中的ByteBuf详解 5. 通过大量实战案例分解Netty中是如何解决拆包黏包问题的?">
<meta property="og:type" content="article">
<meta property="og:title" content="年薪60W分水岭：基于Netty手写实现Dubbo框架">
<meta property="og:url" content="https://istio.tech/posts/2079834576/index.html">
<meta property="og:site_name" content="Mic带你学架构">
<meta property="og:description" content="阅读这篇文章之前，建议先阅读和这篇文章关联的内容。  1. 详细剖析分布式微服务架构下网络通信的底层实现原理（图解） 2. (年薪60W的技巧)工作了5年，你真的理解Netty以及为什么要用吗？（深度干货） 3. 深度解析Netty中的核心组件（图解+实例） 4. BAT面试必问细节：关于Netty中的ByteBuf详解 5. 通过大量实战案例分解Netty中是如何解决拆包黏包问题的?">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/27872_541F965F07E14A4FA8C0CAD39698488C">
<meta property="article:published_time" content="2021-11-18T02:39:00.000Z">
<meta property="article:modified_time" content="2021-11-19T02:41:41.022Z">
<meta property="article:author" content="Mic带你学架构">
<meta property="article:tag" content="RPC">
<meta property="article:tag" content="Dubbo">
<meta property="article:tag" content="Netty手写RPC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/27872_541F965F07E14A4FA8C0CAD39698488C"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://istio.tech/posts/2079834576/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ac9ef9b4d11567dad6043cf089211ab8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: '/js/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '年薪60W分水岭：基于Netty手写实现Dubbo框架',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-11-19 10:41:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" href="/css/index.min.css"><script src="https://readmore.openwrite.cn/js/readmore.js" type="text/javascript"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Mic带你学架构" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">97</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://git.istio.tech"><i class="fa-fw fas fa-fire"></i><span> Git在线学习</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://doc.istio.tech"><i class="fa-fw fas fa-folder-open"></i><span> 常用网址</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://review.istio.tech/"><i class="fa-fw fas fa-fire"></i><span> 面试题合集</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Mic带你学架构</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://git.istio.tech"><i class="fa-fw fas fa-fire"></i><span> Git在线学习</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://doc.istio.tech"><i class="fa-fw fas fa-folder-open"></i><span> 常用网址</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://review.istio.tech/"><i class="fa-fw fas fa-fire"></i><span> 面试题合集</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">年薪60W分水岭：基于Netty手写实现Dubbo框架</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-11-18T02:39:00.000Z" title="发表于 2021-11-18 10:39:00">2021-11-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-11-19T02:41:41.022Z" title="更新于 2021-11-19 10:41:41">2021-11-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Netty/">Netty</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>21分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="年薪60W分水岭：基于Netty手写实现Dubbo框架"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="http://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/27872_541F965F07E14A4FA8C0CAD39698488C" alt="file">  </p>
<blockquote>
<p> 阅读这篇文章之前，建议先阅读和这篇文章关联的内容。</p>
</blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s?__biz=MzI0MzI1Mjg5Nw==&mid=2247484435&idx=1&sn=6ecaaab82bbd15d6b05ad05754501910&chksm=e96eafddde1926cbab2f18d48f3b17886b91a1f176650216e51a212c9474176ef226905a77f3&token=466537573&lang=zh_CN#rd">1. 详细剖析分布式微服务架构下网络通信的底层实现原理（图解）</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s?__biz=MzI0MzI1Mjg5Nw==&mid=2247484460&idx=1&sn=b20c448b02085e24213c5f5e143af932&chksm=e96eafe2de1926f493b25cefbd30d6ed967874684038f895b5d572853791def98d6496142ce7&token=466537573&lang=zh_CN#rd">2. (年薪60W的技巧)工作了5年，你真的理解Netty以及为什么要用吗？（深度干货）</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s?__biz=MzI0MzI1Mjg5Nw==&mid=2247484473&idx=1&sn=c249d3f98d93fb56837f19381bbf43ea&chksm=e96eaff7de1926e12fe125d253faf51dc3b501eee365b8c8c557eb210a5f4e870752af5b9066&token=466537573&lang=zh_CN#rd">3. 深度解析Netty中的核心组件（图解+实例）</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s?__biz=MzI0MzI1Mjg5Nw==&mid=2247484547&idx=1&sn=5bdca72c06b9a521859ed284c58aef64&chksm=e96eaf4dde19265b5d09ac5562761ca49fbf9908c69aa620cea4de11ea000cdbdb51199a7636&token=466537573&lang=zh_CN#rd">4. BAT面试必问细节：关于Netty中的ByteBuf详解</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s?__biz=MzI0MzI1Mjg5Nw==&mid=2247484566&idx=1&sn=4645bec1fca04c9c2c85ae51453ac8b2&chksm=e96eaf58de19264ed761ca10cf2d07d415d65be1019cdf4ad36dc9805aba6c760f2bad82da8e&token=466537573&lang=zh_CN#rd">5. 通过大量实战案例分解Netty中是如何解决拆包黏包问题的?</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s?__biz=MzI0MzI1Mjg5Nw==&mid=2247484576&idx=1&sn=16ddca33b8eae7c4190b5fb491fe8b9c&chksm=e96eaf6ede19267879e9a71a2e7d9686092f2180698d1e9235ade38fb28b1d64547809134170&token=466537573&lang=zh_CN#rd">6. 基于Netty实现自定义消息通信协议（协议设计及解析应用实战）</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s?__biz=MzI0MzI1Mjg5Nw==&mid=2247484591&idx=1&sn=294f20f5b96f613a90a595c6f21e172e&chksm=e96eaf61de19267797a2a1c9ac43da2b5007d4e4658a50e1c4e280843ae0066bee98c3687b50&token=466537573&lang=zh_CN#rd">7. 全网最详细最齐全的序列化技术及深度解析与应用实战</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s?__biz=MzI0MzI1Mjg5Nw==&mid=2247484604&idx=1&sn=b6e1bdfbe02160a20da64717786e6bd7&chksm=e96eaf72de192664c8aaf9f4205f9dc989ec6603a59c4cf1aa50e6f68396c28759f71adf6d90&token=459683109&lang=zh_CN#rd">8. 手把手教你基于Netty实现一个基础的RPC框架（通俗易懂）</a></p>
<p>在本篇文章中，我们继续围绕<a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s?__biz=MzI0MzI1Mjg5Nw==&mid=2247484604&idx=1&sn=b6e1bdfbe02160a20da64717786e6bd7&chksm=e96eaf72de192664c8aaf9f4205f9dc989ec6603a59c4cf1aa50e6f68396c28759f71adf6d90&token=459683109&lang=zh_CN#rd">Netty手写实现RPC基础篇</a>进行优化，主要引入几个点</p>
<ul>
<li>集成spring，实现注解驱动配置</li>
<li>集成zookeeper，实现服务注册</li>
<li>增加负载均衡实现</li>
</ul>
<blockquote>
<p>源代码，加「跟着Mic学架构」微信号，回复『rpc』获取。</p>
</blockquote>
<h1 id="增加注解驱动"><a href="#增加注解驱动" class="headerlink" title="增加注解驱动"></a>增加注解驱动</h1><p>主要涉及到的修改模块</p>
<ul>
<li>netty-rpc-protocol</li>
<li>netty-rpc-provider</li>
</ul>
<h1 id="netty-rpc-protocol"><a href="#netty-rpc-protocol" class="headerlink" title="netty-rpc-protocol"></a>netty-rpc-protocol</h1><p>当前模块主要修改的类如下。</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/202111162213696.png" alt="image-20210908163139333"></p>
<center>图7-1</center>

<p>下面针对netty-rpc-protocol模块的修改如下</p>
<h2 id="增加注解驱动-1"><a href="#增加注解驱动-1" class="headerlink" title="增加注解驱动"></a>增加注解驱动</h2><p>这个注解的作用是用来指定某些服务为远程服务</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span><span class="comment">// Target说明了Annotation所修饰的对象范围, TYPE:用于描述类、接口(包括注解类型) 或enum声明</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span><span class="comment">// Reteniton的作用是定义被它所注解的注解保留多久，保留至运行时。所以我们可以通过反射去获取注解信息。</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GpRemoteService &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SpringRpcProviderBean"><a href="#SpringRpcProviderBean" class="headerlink" title="SpringRpcProviderBean"></a>SpringRpcProviderBean</h2><p>这个类主要用来在启动NettyServer，以及保存bean的映射关系</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringRpcProviderBean</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> serverPort;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String serverAddress; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringRpcProviderBean</span><span class="params">(<span class="keyword">int</span> serverPort)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serverPort = serverPort;</span><br><span class="line">        InetAddress address=InetAddress.getLocalHost();</span><br><span class="line">        <span class="keyword">this</span>.serverAddress=address.getHostAddress();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;begin deploy Netty Server to host &#123;&#125;,on port &#123;&#125;&quot;</span>,<span class="keyword">this</span>.serverAddress,<span class="keyword">this</span>.serverPort);</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">new</span> NettyServer(<span class="keyword">this</span>.serverAddress,<span class="keyword">this</span>.serverPort).startNettyServer();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;start Netty Server Occur Exception,&quot;</span>,e);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//bean实例化后调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(bean.getClass().isAnnotationPresent(GpRemoteService.class))&#123; <span class="comment">//针对存在该注解的服务进行发布</span></span><br><span class="line">            Method[] methods=bean.getClass().getDeclaredMethods();</span><br><span class="line">            <span class="keyword">for</span>(Method method: methods)&#123; <span class="comment">//保存需要发布的bean的映射</span></span><br><span class="line">                String key=bean.getClass().getInterfaces()[<span class="number">0</span>].getName()+<span class="string">&quot;.&quot;</span>+method.getName();</span><br><span class="line">                BeanMethod beanMethod=<span class="keyword">new</span> BeanMethod();</span><br><span class="line">                beanMethod.setBean(bean);</span><br><span class="line">                beanMethod.setMethod(method);</span><br><span class="line">                Mediator.beanMethodMap.put(key,beanMethod);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Mediator"><a href="#Mediator" class="headerlink" title="Mediator"></a>Mediator</h2><p>主要管理bean以及调用</p>
<h3 id="BeanMethod"><a href="#BeanMethod" class="headerlink" title="BeanMethod"></a>BeanMethod</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanMethod</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object bean;</span><br><span class="line">    <span class="keyword">private</span> Method method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Mediator-1"><a href="#Mediator-1" class="headerlink" title="Mediator"></a>Mediator</h3><p>负责持有发布bean的管理，以及bean的反射调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mediator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String,BeanMethod&gt; beanMethodMap=<span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Mediator instance=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Mediator</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Mediator <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Mediator.class)&#123;</span><br><span class="line">                <span class="keyword">if</span>(instance==<span class="keyword">null</span>)&#123;</span><br><span class="line">                    instance=<span class="keyword">new</span> Mediator();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">processor</span><span class="params">(RpcRequest rpcRequest)</span></span>&#123;</span><br><span class="line">        String key=rpcRequest.getClassName()+<span class="string">&quot;.&quot;</span>+rpcRequest.getMethodName();</span><br><span class="line">        BeanMethod beanMethod=beanMethodMap.get(key);</span><br><span class="line">        <span class="keyword">if</span>(beanMethod==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Object bean=beanMethod.getBean();</span><br><span class="line">        Method method=beanMethod.getMethod();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(bean,rpcRequest.getParams());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RpcServerProperties"><a href="#RpcServerProperties" class="headerlink" title="RpcServerProperties"></a>RpcServerProperties</h2><p>定义配置属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;gp.rpc&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcServerProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> servicePort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RpcProviderAutoConfiguration"><a href="#RpcProviderAutoConfiguration" class="headerlink" title="RpcProviderAutoConfiguration"></a>RpcProviderAutoConfiguration</h2><p>定义自动配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RpcServerProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcProviderAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringRpcProviderBean <span class="title">rpcProviderBean</span><span class="params">(RpcServerProperties rpcServerProperties)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringRpcProviderBean(rpcServerProperties.getServicePort());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改RpcServerHandler"><a href="#修改RpcServerHandler" class="headerlink" title="修改RpcServerHandler"></a>修改RpcServerHandler</h2><p>修改调用方式，直接使用Mediator的调用即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">RpcProtocol</span>&lt;<span class="title">RpcRequest</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RpcProtocol&lt;RpcRequest&gt; msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        RpcProtocol resProtocol=<span class="keyword">new</span> RpcProtocol&lt;&gt;();</span><br><span class="line">        Header header=msg.getHeader();</span><br><span class="line">        header.setReqType(ReqType.RESPONSE.code());</span><br><span class="line">        Object result=Mediator.getInstance().processor(msg.getContent()); <span class="comment">//主要修改这个部分</span></span><br><span class="line">        resProtocol.setHeader(header);</span><br><span class="line">        RpcResponse response=<span class="keyword">new</span> RpcResponse();</span><br><span class="line">        response.setData(result);</span><br><span class="line">        response.setMsg(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        resProtocol.setContent(response);</span><br><span class="line"></span><br><span class="line">        ctx.writeAndFlush(resProtocol);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="netty-rpc-provider"><a href="#netty-rpc-provider" class="headerlink" title="netty-rpc-provider"></a>netty-rpc-provider</h1><p>这个模块中主要修改两个部分</p>
<ul>
<li>application.properties</li>
<li>NettyRpcProviderMain</li>
</ul>
<h2 id="NettyRpcProviderMain"><a href="#NettyRpcProviderMain" class="headerlink" title="NettyRpcProviderMain"></a>NettyRpcProviderMain</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;com.example.spring.annotation&quot;,&quot;com.example.spring.service&quot;,&quot;com.example.service&quot;&#125;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyRpcProviderMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SpringApplication.run(NettyRpcProviderMain.class, args);</span><br><span class="line">        <span class="comment">//去掉原来的实例化部分</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h2><p>增加一个配置属性。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">gp.rpc.servicePort=<span class="number">20880</span></span><br></pre></td></tr></table></figure>

<h2 id="UserServiceImpl"><a href="#UserServiceImpl" class="headerlink" title="UserServiceImpl"></a>UserServiceImpl</h2><p>把当前服务发布出去。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GpRemoteService</span> <span class="comment">//表示将当前服务发布成远程服务</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">saveUser</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;begin saveUser:&quot;</span>+name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Save User Success!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="修改客户端的注解驱动"><a href="#修改客户端的注解驱动" class="headerlink" title="修改客户端的注解驱动"></a>修改客户端的注解驱动</h1><p>客户端同样也需要通过注解的方式来引用服务，这样就能够彻底的屏蔽掉远程通信的细节内容，代码结构如图7-2所示</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/202111162213947.png" alt="image-20210908180518683"></p>
<center>图7-2</center>

<h2 id="增加客户端注解"><a href="#增加客户端注解" class="headerlink" title="增加客户端注解"></a>增加客户端注解</h2><p>在netty-rpc-protocol模块的annotation目录下创建下面这个注解。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.FIELD)</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GpRemoteReference &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SpringRpcReferenceBean"><a href="#SpringRpcReferenceBean" class="headerlink" title="SpringRpcReferenceBean"></a>SpringRpcReferenceBean</h2><p>定义工厂Bean，用来构建远程通信的代理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringRpcReferenceBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; interfaceClass;</span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line">    <span class="keyword">private</span> String serviceAddress;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> servicePort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.object= Proxy.newProxyInstance(<span class="keyword">this</span>.interfaceClass.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> Class&lt;?&gt;[]&#123;<span class="keyword">this</span>.interfaceClass&#125;,</span><br><span class="line">                <span class="keyword">new</span> RpcInvokerProxy(<span class="keyword">this</span>.serviceAddress,<span class="keyword">this</span>.servicePort));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.interfaceClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInterfaceClass</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.interfaceClass = interfaceClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServiceAddress</span><span class="params">(String serviceAddress)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serviceAddress = serviceAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServicePort</span><span class="params">(<span class="keyword">int</span> servicePort)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.servicePort = servicePort;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SpringRpcReferencePostProcessor"><a href="#SpringRpcReferencePostProcessor" class="headerlink" title="SpringRpcReferencePostProcessor"></a>SpringRpcReferencePostProcessor</h2><p>用来实现远程Bean的动态代理注入：</p>
<ul>
<li><p>BeanClassLoaderAware： 获取Bean的类装载器</p>
</li>
<li><p>BeanFactoryPostProcessor：在spring容器加载了bean的定义文件之后，在bean实例化之前执行</p>
</li>
<li><p>ApplicationContextAware： 获取上下文对象ApplicationContenxt</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringRpcReferencePostProcessor</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line">    <span class="keyword">private</span> RpcClientProperties clientProperties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringRpcReferencePostProcessor</span><span class="params">(RpcClientProperties clientProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientProperties = clientProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存发布的引用bean信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; rpcRefBeanDefinitions=<span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classLoader=classLoader;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context=applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String beanDefinitionname:beanFactory.getBeanDefinitionNames())&#123;</span><br><span class="line">            <span class="comment">//遍历bean定义，然后获取到加载的bean，遍历这些bean中的字段，是否携带GpRemoteReference注解</span></span><br><span class="line">            <span class="comment">//如果有，则需要构建一个动态代理实现</span></span><br><span class="line">            BeanDefinition beanDefinition=beanFactory.getBeanDefinition(beanDefinitionname);</span><br><span class="line">            String beanClassName=beanDefinition.getBeanClassName();</span><br><span class="line">            <span class="keyword">if</span>(beanClassName!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="comment">//和forName方法相同，内部就是直接调用的forName方法</span></span><br><span class="line">                Class&lt;?&gt; clazz=ClassUtils.resolveClassName(beanClassName,<span class="keyword">this</span>.classLoader);</span><br><span class="line">                <span class="comment">//针对当前类中的指定字段，动态创建一个Bean</span></span><br><span class="line">                ReflectionUtils.doWithFields(clazz,<span class="keyword">this</span>::parseRpcReference);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将@GpRemoteReference注解的bean，构建一个动态代理对象</span></span><br><span class="line">        BeanDefinitionRegistry registry=(BeanDefinitionRegistry)beanFactory;</span><br><span class="line">        <span class="keyword">this</span>.rpcRefBeanDefinitions.forEach((beanName,beanDefinition)-&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(context.containsBean(beanName))&#123;</span><br><span class="line">                log.warn(<span class="string">&quot;SpringContext already register bean &#123;&#125;&quot;</span>,beanName);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//把动态创建的bean注册到容器中</span></span><br><span class="line">            registry.registerBeanDefinition(beanName,beanDefinition);</span><br><span class="line">            log.info(<span class="string">&quot;registered RpcReferenceBean &#123;&#125; success.&quot;</span>,beanName);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRpcReference</span><span class="params">(Field field)</span></span>&#123;</span><br><span class="line">        GpRemoteReference gpRemoteReference=AnnotationUtils.getAnnotation(field,GpRemoteReference.class);</span><br><span class="line">        <span class="keyword">if</span>(gpRemoteReference!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            BeanDefinitionBuilder builder=BeanDefinitionBuilder.genericBeanDefinition(SpringRpcReferenceBean.class);</span><br><span class="line">            builder.setInitMethodName(RpcConstant.INIT_METHOD_NAME);</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;interfaceClass&quot;</span>,field.getType());</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;serviceAddress&quot;</span>,clientProperties.getServiceAddress());</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;servicePort&quot;</span>,clientProperties.getServicePort());</span><br><span class="line">            BeanDefinition beanDefinition=builder.getBeanDefinition();</span><br><span class="line">            rpcRefBeanDefinitions.put(field.getName(),beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要在RpcConstant常量中增加一个INIT_METHOD_NAME属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcConstant</span> </span>&#123;</span><br><span class="line">    <span class="comment">//header部分的总字节数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> HEAD_TOTAL_LEN=<span class="number">16</span>;</span><br><span class="line">    <span class="comment">//魔数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">short</span> MAGIC=<span class="number">0xca</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String INIT_METHOD_NAME = <span class="string">&quot;init&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RpcClientProperties"><a href="#RpcClientProperties" class="headerlink" title="RpcClientProperties"></a>RpcClientProperties</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcClientProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String serviceAddress=<span class="string">&quot;192.168.1.102&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> servicePort=<span class="number">20880</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RpcRefernceAutoConfiguration"><a href="#RpcRefernceAutoConfiguration" class="headerlink" title="RpcRefernceAutoConfiguration"></a>RpcRefernceAutoConfiguration</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcRefernceAutoConfiguration</span> <span class="keyword">implements</span> <span class="title">EnvironmentAware</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringRpcReferencePostProcessor <span class="title">postProcessor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String address=environment.getProperty(<span class="string">&quot;gp.serviceAddress&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> port=Integer.parseInt(environment.getProperty(<span class="string">&quot;gp.servicePort&quot;</span>));</span><br><span class="line">        RpcClientProperties rc=<span class="keyword">new</span> RpcClientProperties();</span><br><span class="line">        rc.setServiceAddress(address);</span><br><span class="line">        rc.setServicePort(port);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringRpcReferencePostProcessor(rc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.environment=environment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="netty-rpc-consumer"><a href="#netty-rpc-consumer" class="headerlink" title="netty-rpc-consumer"></a>netty-rpc-consumer</h1><p>修改netty-rpc-consumer模块</p>
<ul>
<li>把该模块变成一个spring boot项目</li>
<li>增加web依赖</li>
<li>添加测试类</li>
</ul>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/202111162213865.png" alt="image-20210908183814586"></p>
<center>图7-3 netty-rpc-consumer模块</center>

<h2 id="引入jar包依赖"><a href="#引入jar包依赖" class="headerlink" title="引入jar包依赖"></a>引入jar包依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="HelloController"><a href="#HelloController" class="headerlink" title="HelloController"></a>HelloController</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GpRemoteReference</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.saveUser(<span class="string">&quot;Mic&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NettyConsumerMain"><a href="#NettyConsumerMain" class="headerlink" title="NettyConsumerMain"></a>NettyConsumerMain</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;com.example.spring.annotation&quot;,&quot;com.example.controller&quot;,&quot;com.example.spring.reference&quot;&#125;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyConsumerMain</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(NettyConsumerMain.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="application-properties-1"><a href="#application-properties-1" class="headerlink" title="application.properties"></a>application.properties</h2><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">gp.serviceAddress</span>=<span class="string">192.168.1.102</span></span><br><span class="line"><span class="meta">servicePort.servicePort</span>=<span class="string">20880</span></span><br></pre></td></tr></table></figure>

<h2 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h2><ul>
<li>启动Netty-Rpc-Server</li>
<li>启动Netty-Rpc-Consumer</li>
</ul>
<p>如果启动过程没有任何问题，则可以访问HelloController来测试远程服务的访问。</p>
<h1 id="引入注册中心"><a href="#引入注册中心" class="headerlink" title="引入注册中心"></a>引入注册中心</h1><p>创建一个netty-rpc-registry模块，代码结构如图7-4所示。</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/202111162213827.png" alt="image-20210909174008427"></p>
<blockquote>
<p>引入相关依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-x-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="IRegistryService"><a href="#IRegistryService" class="headerlink" title="IRegistryService"></a>IRegistryService</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IRegistryService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(ServiceInfo serviceInfo)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消注册</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unRegister</span><span class="params">(ServiceInfo serviceInfo)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 动态发现服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ServiceInfo <span class="title">discovery</span><span class="params">(String serviceName)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ServiceInfo"><a href="#ServiceInfo" class="headerlink" title="ServiceInfo"></a>ServiceInfo</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceInfo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String serviceName;</span><br><span class="line">    <span class="keyword">private</span> String serviceAddress;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> servicePort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ZookeeperRegistryService"><a href="#ZookeeperRegistryService" class="headerlink" title="ZookeeperRegistryService"></a>ZookeeperRegistryService</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperRegistryService</span> <span class="keyword">implements</span> <span class="title">IRegistryService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGISTRY_PATH=<span class="string">&quot;/registry&quot;</span>;</span><br><span class="line">    <span class="comment">//Curator中提供的服务注册与发现的组件封装，它对此抽象出了ServiceInstance、</span></span><br><span class="line">    <span class="comment">// ServiceProvider、ServiceDiscovery三个接口，通过它我们可以很轻易的实现Service Discovery</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServiceDiscovery&lt;ServiceInfo&gt; serviceDiscovery;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ILoadBalance&lt;ServiceInstance&lt;ServiceInfo&gt;&gt; loadBalance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZookeeperRegistryService</span><span class="params">(String registryAddress)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        CuratorFramework client= CuratorFrameworkFactory</span><br><span class="line">                .newClient(registryAddress,<span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>,<span class="number">3</span>));</span><br><span class="line">        JsonInstanceSerializer&lt;ServiceInfo&gt; serializer=<span class="keyword">new</span> JsonInstanceSerializer&lt;&gt;(ServiceInfo.class);</span><br><span class="line">        <span class="keyword">this</span>.serviceDiscovery= ServiceDiscoveryBuilder.builder(ServiceInfo.class)</span><br><span class="line">                .client(client)</span><br><span class="line">                .serializer(serializer)</span><br><span class="line">                .basePath(REGISTRY_PATH)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">this</span>.serviceDiscovery.start();</span><br><span class="line">        loadBalance=<span class="keyword">new</span> RandomLoadBalance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(ServiceInfo serviceInfo)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始注册服务，&#123;&#125;&quot;</span>,serviceInfo);</span><br><span class="line">        ServiceInstance&lt;ServiceInfo&gt; serviceInstance=ServiceInstance</span><br><span class="line">                .&lt;ServiceInfo&gt;builder().name(serviceInfo.getServiceName())</span><br><span class="line">                .address(serviceInfo.getServiceAddress())</span><br><span class="line">                .port(serviceInfo.getServicePort())</span><br><span class="line">                .payload(serviceInfo)</span><br><span class="line">                .build();</span><br><span class="line">        serviceDiscovery.registerService(serviceInstance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unRegister</span><span class="params">(ServiceInfo serviceInfo)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ServiceInstance&lt;ServiceInfo&gt; serviceInstance=ServiceInstance.&lt;ServiceInfo&gt;builder()</span><br><span class="line">                .name(serviceInfo.getServiceName())</span><br><span class="line">                .address(serviceInfo.getServiceAddress())</span><br><span class="line">                .port(serviceInfo.getServicePort())</span><br><span class="line">                .payload(serviceInfo)</span><br><span class="line">                .build();</span><br><span class="line">        serviceDiscovery.unregisterService(serviceInstance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServiceInfo <span class="title">discovery</span><span class="params">(String serviceName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Collection&lt;ServiceInstance&lt;ServiceInfo&gt;&gt; serviceInstances= serviceDiscovery</span><br><span class="line">                .queryForInstances(serviceName);</span><br><span class="line">        <span class="comment">//通过负载均衡返回某个具体实例</span></span><br><span class="line">        ServiceInstance&lt;ServiceInfo&gt; serviceInstance=loadBalance.select((List&lt;ServiceInstance&lt;ServiceInfo&gt;&gt;)serviceInstances);</span><br><span class="line">        <span class="keyword">if</span>(serviceInstance!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> serviceInstance.getPayload();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="引入负载均衡算法"><a href="#引入负载均衡算法" class="headerlink" title="引入负载均衡算法"></a>引入负载均衡算法</h2><p>由于服务端发现服务时可能有多个，所以需要用到负载均衡算法来实现</p>
<h3 id="ILoadBalance"><a href="#ILoadBalance" class="headerlink" title="ILoadBalance"></a>ILoadBalance</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ILoadBalance</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">select</span><span class="params">(List&lt;T&gt; servers)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AbstractLoadBalance"><a href="#AbstractLoadBalance" class="headerlink" title="AbstractLoadBalance"></a>AbstractLoadBalance</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLoadBanalce</span> <span class="keyword">implements</span> <span class="title">ILoadBalance</span>&lt;<span class="title">ServiceInstance</span>&lt;<span class="title">ServiceInfo</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServiceInstance&lt;ServiceInfo&gt; <span class="title">select</span><span class="params">(List&lt;ServiceInstance&lt;ServiceInfo&gt;&gt; servers)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(servers==<span class="keyword">null</span>||servers.size()==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(servers.size()==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> servers.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> doSelect(servers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> ServiceInstance&lt;ServiceInfo&gt; <span class="title">doSelect</span><span class="params">(List&lt;ServiceInstance&lt;ServiceInfo&gt;&gt; servers)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RandomLoadBalance"><a href="#RandomLoadBalance" class="headerlink" title="RandomLoadBalance"></a>RandomLoadBalance</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomLoadBalance</span> <span class="keyword">extends</span> <span class="title">AbstractLoadBanalce</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ServiceInstance&lt;ServiceInfo&gt; <span class="title">doSelect</span><span class="params">(List&lt;ServiceInstance&lt;ServiceInfo&gt;&gt; servers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length=servers.size();</span><br><span class="line">        Random random=<span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">return</span> servers.get(random.nextInt(length));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RegistryType"><a href="#RegistryType" class="headerlink" title="RegistryType"></a>RegistryType</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">RegistryType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ZOOKEEPER((<span class="keyword">byte</span>)<span class="number">0</span>),</span><br><span class="line">    EUREKA((<span class="keyword">byte</span>)<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> code;</span><br><span class="line"></span><br><span class="line">    RegistryType(<span class="keyword">byte</span> code) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code=code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">byte</span> <span class="title">code</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RegistryType <span class="title">findByCode</span><span class="params">(<span class="keyword">byte</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (RegistryType rt : RegistryType.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rt.code() == code) &#123;</span><br><span class="line">                <span class="keyword">return</span> rt;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RegistryFactory"><a href="#RegistryFactory" class="headerlink" title="RegistryFactory"></a>RegistryFactory</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistryFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IRegistryService <span class="title">createRegistryService</span><span class="params">(String address,RegistryType registryType)</span></span>&#123;</span><br><span class="line">        IRegistryService registryService=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (registryType) &#123;</span><br><span class="line">                <span class="keyword">case</span> ZOOKEEPER:</span><br><span class="line">                    registryService = <span class="keyword">new</span> ZookeeperRegistryService(address);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> EUREKA:</span><br><span class="line">                    <span class="comment">//TODO</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    registryService = <span class="keyword">new</span> ZookeeperRegistryService(address);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> registryService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="修改服务端增加服务注册"><a href="#修改服务端增加服务注册" class="headerlink" title="修改服务端增加服务注册"></a>修改服务端增加服务注册</h1><p>修改netty-rpc-protocol模块，加入注册中心的支持</p>
<h2 id="SpringRpcProviderBean-1"><a href="#SpringRpcProviderBean-1" class="headerlink" title="SpringRpcProviderBean"></a>SpringRpcProviderBean</h2><p>按照下面case标注部分，表示要修改的内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringRpcProviderBean</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> serverPort;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String serverAddress;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IRegistryService registryService; <span class="comment">//修改部分,增加注册中心实现</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringRpcProviderBean</span><span class="params">(<span class="keyword">int</span> serverPort,IRegistryService registryService)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serverPort = serverPort;</span><br><span class="line">        InetAddress address=InetAddress.getLocalHost();</span><br><span class="line">        <span class="keyword">this</span>.serverAddress=address.getHostAddress();</span><br><span class="line">        <span class="keyword">this</span>.registryService=registryService; <span class="comment">//修改部分,增加注册中心实现</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;begin deploy Netty Server to host &#123;&#125;,on port &#123;&#125;&quot;</span>,<span class="keyword">this</span>.serverAddress,<span class="keyword">this</span>.serverPort);</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">new</span> NettyServer(<span class="keyword">this</span>.serverAddress,<span class="keyword">this</span>.serverPort).startNettyServer();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;start Netty Server Occur Exception,&quot;</span>,e);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(bean.getClass().isAnnotationPresent(GpRemoteService.class))&#123; <span class="comment">//针对存在该注解的服务进行发布</span></span><br><span class="line">            Method[] methods=bean.getClass().getDeclaredMethods();</span><br><span class="line">            <span class="keyword">for</span>(Method method: methods)&#123;</span><br><span class="line">                String serviceName=bean.getClass().getInterfaces()[<span class="number">0</span>].getName();</span><br><span class="line">                String key=serviceName+<span class="string">&quot;.&quot;</span>+method.getName();</span><br><span class="line">                BeanMethod beanMethod=<span class="keyword">new</span> BeanMethod();</span><br><span class="line">                beanMethod.setBean(bean);</span><br><span class="line">                beanMethod.setMethod(method);</span><br><span class="line">                Mediator.beanMethodMap.put(key,beanMethod);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//修改部分,增加注册中心实现</span></span><br><span class="line">                    ServiceInfo serviceInfo = <span class="keyword">new</span> ServiceInfo();</span><br><span class="line">                    serviceInfo.setServiceAddress(<span class="keyword">this</span>.serverAddress);</span><br><span class="line">                    serviceInfo.setServicePort(<span class="keyword">this</span>.serverPort);</span><br><span class="line">                    serviceInfo.setServiceName(serviceName);</span><br><span class="line">                    registryService.register(serviceInfo);<span class="comment">//修改部分,增加注册中心实现</span></span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    log.error(<span class="string">&quot;register service &#123;&#125; faild&quot;</span>,serviceName,e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RpcServerProperties-1"><a href="#RpcServerProperties-1" class="headerlink" title="RpcServerProperties"></a>RpcServerProperties</h2><p>修改RpcServerProperties，增加注册中心的配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;gp.rpc&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcServerProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> servicePort;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> registerType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String registryAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RpcProviderAutoConfiguration-1"><a href="#RpcProviderAutoConfiguration-1" class="headerlink" title="RpcProviderAutoConfiguration"></a>RpcProviderAutoConfiguration</h2><p>增加注册中心的注入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RpcServerProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcProviderAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringRpcProviderBean <span class="title">rpcProviderBean</span><span class="params">(RpcServerProperties rpcServerProperties)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">        <span class="comment">//添加注册中心</span></span><br><span class="line">        IRegistryService registryService=RegistryFactory.createRegistryService(rpcServerProperties.getRegistryAddress(), RegistryType.findByCode(rpcServerProperties.getRegisterType()));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringRpcProviderBean(rpcServerProperties.getServicePort(),registryService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="application-properties-2"><a href="#application-properties-2" class="headerlink" title="application.properties"></a>application.properties</h2><p>修改netty-rpc-provider中的application.properties。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">gp.rpc.servicePort</span>=<span class="string">20880</span></span><br><span class="line"><span class="meta">gp.rpc.registerType</span>=<span class="string">0</span></span><br><span class="line"><span class="meta">gp.rpc.registryAddress</span>=<span class="string">192.168.221.128:2181</span></span><br></pre></td></tr></table></figure>

<h1 id="修改客户端，增加服务发现"><a href="#修改客户端，增加服务发现" class="headerlink" title="修改客户端，增加服务发现"></a>修改客户端，增加服务发现</h1><p>客户端需要修改的地方较多，下面这些修改的代码，都是netty-rpc-protocol模块中的类。</p>
<h2 id="RpcClientProperties-1"><a href="#RpcClientProperties-1" class="headerlink" title="RpcClientProperties"></a>RpcClientProperties</h2><p>增加注册中心类型和注册中心地址的选项</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcClientProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String serviceAddress=<span class="string">&quot;192.168.1.102&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> servicePort=<span class="number">20880</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> registryType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String registryAddress;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改NettyClient"><a href="#修改NettyClient" class="headerlink" title="修改NettyClient"></a>修改NettyClient</h2><p>原本是静态地址，现在修改成了从注册中心获取地址</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Bootstrap bootstrap;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup eventLoopGroup=<span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">   <span class="comment">/* private String serviceAddress;</span></span><br><span class="line"><span class="comment">    private int servicePort;*/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NettyClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;begin init NettyClient&quot;</span>);</span><br><span class="line">        bootstrap=<span class="keyword">new</span> Bootstrap();</span><br><span class="line">        bootstrap.group(eventLoopGroup)</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .handler(<span class="keyword">new</span> RpcClientInitializer());</span><br><span class="line">       <span class="comment">/* this.serviceAddress=serviceAddress;</span></span><br><span class="line"><span class="comment">        this.servicePort=servicePort;*/</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(RpcProtocol&lt;RpcRequest&gt; protocol, IRegistryService registryService)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ServiceInfo serviceInfo=registryService.discovery(protocol.getContent().getClassName());</span><br><span class="line">        ChannelFuture future=bootstrap.connect(serviceInfo.getServiceAddress(),serviceInfo.getServicePort()).sync();</span><br><span class="line">        future.addListener(listener-&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(future.isSuccess())&#123;</span><br><span class="line">                log.info(<span class="string">&quot;connect rpc server &#123;&#125; success.&quot;</span>,serviceInfo.getServiceAddress());</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                log.error(<span class="string">&quot;connect rpc server &#123;&#125; failed .&quot;</span>,serviceInfo.getServiceAddress());</span><br><span class="line">                future.cause().printStackTrace();</span><br><span class="line">                eventLoopGroup.shutdownGracefully();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        log.info(<span class="string">&quot;begin transfer data&quot;</span>);</span><br><span class="line">        future.channel().writeAndFlush(protocol);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改RpcInvokerProxy"><a href="#修改RpcInvokerProxy" class="headerlink" title="修改RpcInvokerProxy"></a>修改RpcInvokerProxy</h2><p>将静态ip和地址，修改成IRegistryService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcInvokerProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* private String serviceAddress;</span></span><br><span class="line"><span class="comment">    private int servicePort;*/</span></span><br><span class="line"></span><br><span class="line">    IRegistryService registryService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RpcInvokerProxy</span><span class="params">(IRegistryService registryService)</span> </span>&#123;</span><br><span class="line">       <span class="comment">/* this.serviceAddress = serviceAddress;</span></span><br><span class="line"><span class="comment">        this.servicePort = servicePort;*/</span></span><br><span class="line">        <span class="keyword">this</span>.registryService=registryService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;begin invoke target server&quot;</span>);</span><br><span class="line">        <span class="comment">//组装参数</span></span><br><span class="line">        RpcProtocol&lt;RpcRequest&gt; protocol=<span class="keyword">new</span> RpcProtocol&lt;&gt;();</span><br><span class="line">        <span class="keyword">long</span> requestId= RequestHolder.REQUEST_ID.incrementAndGet();</span><br><span class="line">        Header header=<span class="keyword">new</span> Header(RpcConstant.MAGIC, SerialType.JSON_SERIAL.code(), ReqType.REQUEST.code(),requestId,<span class="number">0</span>);</span><br><span class="line">        protocol.setHeader(header);</span><br><span class="line">        RpcRequest request=<span class="keyword">new</span> RpcRequest();</span><br><span class="line">        request.setClassName(method.getDeclaringClass().getName());</span><br><span class="line">        request.setMethodName(method.getName());</span><br><span class="line">        request.setParameterTypes(method.getParameterTypes());</span><br><span class="line">        request.setParams(args);</span><br><span class="line">        protocol.setContent(request);</span><br><span class="line">        <span class="comment">//发送请求</span></span><br><span class="line">        NettyClient nettyClient=<span class="keyword">new</span> NettyClient();</span><br><span class="line">        <span class="comment">//构建异步数据处理</span></span><br><span class="line">        RpcFuture&lt;RpcResponse&gt; future=<span class="keyword">new</span> RpcFuture&lt;&gt;(<span class="keyword">new</span> DefaultPromise&lt;&gt;(<span class="keyword">new</span> DefaultEventLoop()));</span><br><span class="line">        RequestHolder.REQUEST_MAP.put(requestId,future);</span><br><span class="line">        nettyClient.sendRequest(protocol,<span class="keyword">this</span>.registryService);</span><br><span class="line">        <span class="keyword">return</span> future.getPromise().get().getData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SpringRpcReferenceBean-1"><a href="#SpringRpcReferenceBean-1" class="headerlink" title="SpringRpcReferenceBean"></a>SpringRpcReferenceBean</h2><p>修改引用bean，增加注册中心配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringRpcReferenceBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; interfaceClass;</span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line">   <span class="comment">/* private String serviceAddress;</span></span><br><span class="line"><span class="comment">    private int servicePort;*/</span></span><br><span class="line">    <span class="comment">//修改增加注册中心</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> registryType;</span><br><span class="line">    <span class="keyword">private</span> String registryAddress;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//修改增加注册中心</span></span><br><span class="line">        IRegistryService registryService= RegistryFactory.createRegistryService(<span class="keyword">this</span>.registryAddress, RegistryType.findByCode(<span class="keyword">this</span>.registryType));</span><br><span class="line">        <span class="keyword">this</span>.object= Proxy.newProxyInstance(<span class="keyword">this</span>.interfaceClass.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> Class&lt;?&gt;[]&#123;<span class="keyword">this</span>.interfaceClass&#125;,</span><br><span class="line">                <span class="keyword">new</span> RpcInvokerProxy(registryService));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.interfaceClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInterfaceClass</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.interfaceClass = interfaceClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* public void setServiceAddress(String serviceAddress) &#123;</span></span><br><span class="line"><span class="comment">        this.serviceAddress = serviceAddress;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    public void setServicePort(int servicePort) &#123;</span></span><br><span class="line"><span class="comment">        this.servicePort = servicePort;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRegistryType</span><span class="params">(<span class="keyword">byte</span> registryType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.registryType = registryType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRegistryAddress</span><span class="params">(String registryAddress)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.registryAddress = registryAddress;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SpringRpcReferencePostProcessor-1"><a href="#SpringRpcReferencePostProcessor-1" class="headerlink" title="SpringRpcReferencePostProcessor"></a>SpringRpcReferencePostProcessor</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringRpcReferencePostProcessor</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line">    <span class="keyword">private</span> RpcClientProperties clientProperties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringRpcReferencePostProcessor</span><span class="params">(RpcClientProperties clientProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientProperties = clientProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存发布的引用bean信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; rpcRefBeanDefinitions=<span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classLoader=classLoader;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context=applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String beanDefinitionname:beanFactory.getBeanDefinitionNames())&#123;</span><br><span class="line">            <span class="comment">//遍历bean定义，然后获取到加载的bean，遍历这些bean中的字段，是否携带GpRemoteReference注解</span></span><br><span class="line">            <span class="comment">//如果有，则需要构建一个动态代理实现</span></span><br><span class="line">            BeanDefinition beanDefinition=beanFactory.getBeanDefinition(beanDefinitionname);</span><br><span class="line">            String beanClassName=beanDefinition.getBeanClassName();</span><br><span class="line">            <span class="keyword">if</span>(beanClassName!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                Class&lt;?&gt; clazz=ClassUtils.resolveClassName(beanClassName,<span class="keyword">this</span>.classLoader);</span><br><span class="line">                ReflectionUtils.doWithFields(clazz,<span class="keyword">this</span>::parseRpcReference);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将@GpRemoteReference注解的bean，构建一个动态代理对象</span></span><br><span class="line">        BeanDefinitionRegistry registry=(BeanDefinitionRegistry)beanFactory;</span><br><span class="line">        <span class="keyword">this</span>.rpcRefBeanDefinitions.forEach((beanName,beanDefinition)-&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(context.containsBean(beanName))&#123;</span><br><span class="line">                log.warn(<span class="string">&quot;SpringContext already register bean &#123;&#125;&quot;</span>,beanName);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            registry.registerBeanDefinition(beanName,beanDefinition);</span><br><span class="line">            log.info(<span class="string">&quot;registered RpcReferenceBean &#123;&#125; success.&quot;</span>,beanName);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRpcReference</span><span class="params">(Field field)</span></span>&#123;</span><br><span class="line">        GpRemoteReference gpRemoteReference=AnnotationUtils.getAnnotation(field,GpRemoteReference.class);</span><br><span class="line">        <span class="keyword">if</span>(gpRemoteReference!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            BeanDefinitionBuilder builder=BeanDefinitionBuilder.genericBeanDefinition(SpringRpcReferenceBean.class);</span><br><span class="line">            builder.setInitMethodName(RpcConstant.INIT_METHOD_NAME);</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;interfaceClass&quot;</span>,field.getType());</span><br><span class="line">            <span class="comment">/*builder.addPropertyValue(&quot;serviceAddress&quot;,clientProperties.getServiceAddress());</span></span><br><span class="line"><span class="comment">            builder.addPropertyValue(&quot;servicePort&quot;,clientProperties.getServicePort());*/</span></span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;registryType&quot;</span>,clientProperties.getRegistryType());</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;registryAddress&quot;</span>,clientProperties.getRegistryAddress());</span><br><span class="line">            BeanDefinition beanDefinition=builder.getBeanDefinition();</span><br><span class="line">            rpcRefBeanDefinitions.put(field.getName(),beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RpcRefernceAutoConfiguration-1"><a href="#RpcRefernceAutoConfiguration-1" class="headerlink" title="RpcRefernceAutoConfiguration"></a>RpcRefernceAutoConfiguration</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcRefernceAutoConfiguration</span> <span class="keyword">implements</span> <span class="title">EnvironmentAware</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringRpcReferencePostProcessor <span class="title">postProcessor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String address=environment.getProperty(<span class="string">&quot;gp.serviceAddress&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> port=Integer.parseInt(environment.getProperty(<span class="string">&quot;gp.servicePort&quot;</span>));</span><br><span class="line">        RpcClientProperties rc=<span class="keyword">new</span> RpcClientProperties();</span><br><span class="line">        rc.setServiceAddress(address);</span><br><span class="line">        rc.setServicePort(port);</span><br><span class="line">        rc.setRegistryType(Byte.parseByte(environment.getProperty(<span class="string">&quot;gp.registryType&quot;</span>)));</span><br><span class="line">        rc.setRegistryAddress(environment.getProperty(<span class="string">&quot;gp.registryAddress&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringRpcReferencePostProcessor(rc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.environment=environment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="application-properties-3"><a href="#application-properties-3" class="headerlink" title="application.properties"></a>application.properties</h2><p>修改netty-rpc-consumer模块中的配置</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">gp.serviceAddress</span>=<span class="string">192.168.1.102</span></span><br><span class="line"><span class="meta">gp.servicePort</span>=<span class="string">20880</span></span><br><span class="line"></span><br><span class="line"><span class="meta">gp.registryType</span>=<span class="string">0</span></span><br><span class="line"><span class="meta">gp.registryAddress</span>=<span class="string">192.168.221.128:2181</span></span><br></pre></td></tr></table></figure>

<h1 id="负载均衡的测试"><a href="#负载均衡的测试" class="headerlink" title="负载均衡的测试"></a>负载均衡的测试</h1><p>增加一个服务端的启动类，并且修改端口。然后客户端不需要重启的情况下刷新浏览器，即可看到负载均衡的效果。</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/202111162213993.png" alt="image-20210909202149527"></p>
<center>图7-5</center>

<p><strong>需要源码的同学，请关注公众号[跟着Mic学架构]，回复关键字[rpc]，即可获得</strong></p>
</article><script>var btw = new BTWPlugin();
  btw.init({
  id: 'article-container',
  blogId: '27872-1635073785708-735',
  name: '跟着Mic学架构',
  qrcode: 'https://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/qrcode_for_gh_2ca1c20d4f6c_860.jpg',
  keyword: 'more',
  });</script><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Mic带你学架构</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://istio.tech/posts/2079834576/">https://istio.tech/posts/2079834576/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://istio.tech" target="_blank">Mic带你学架构</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/RPC/">RPC</a><a class="post-meta__tags" href="/tags/Dubbo/">Dubbo</a><a class="post-meta__tags" href="/tags/Netty%E6%89%8B%E5%86%99RPC/">Netty手写RPC</a></div><div class="post_share"><div class="social-share" data-image="http://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/27872_541F965F07E14A4FA8C0CAD39698488C" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/1953088977/"><img class="prev-cover" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/images/pasted-7.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">软件安装系列教程：Centos7中安装Redis6.x</div></div></a></div><div class="next-post pull-right"><a href="/posts/1855042396/"><img class="next-cover" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/images/pasted-6.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">手把手教你基于Netty实现一个基础的RPC框架（通俗易懂）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/1855042396/" title="手把手教你基于Netty实现一个基础的RPC框架（通俗易懂）"><img class="cover" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/images/pasted-6.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-17</div><div class="title">手把手教你基于Netty实现一个基础的RPC框架（通俗易懂）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E6%B3%A8%E8%A7%A3%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.</span> <span class="toc-text">增加注解驱动</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#netty-rpc-protocol"><span class="toc-number">2.</span> <span class="toc-text">netty-rpc-protocol</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E6%B3%A8%E8%A7%A3%E9%A9%B1%E5%8A%A8-1"><span class="toc-number">2.1.</span> <span class="toc-text">增加注解驱动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringRpcProviderBean"><span class="toc-number">2.2.</span> <span class="toc-text">SpringRpcProviderBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mediator"><span class="toc-number">2.3.</span> <span class="toc-text">Mediator</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BeanMethod"><span class="toc-number">2.3.1.</span> <span class="toc-text">BeanMethod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mediator-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">Mediator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RpcServerProperties"><span class="toc-number">2.4.</span> <span class="toc-text">RpcServerProperties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RpcProviderAutoConfiguration"><span class="toc-number">2.5.</span> <span class="toc-text">RpcProviderAutoConfiguration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9RpcServerHandler"><span class="toc-number">2.6.</span> <span class="toc-text">修改RpcServerHandler</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#netty-rpc-provider"><span class="toc-number">3.</span> <span class="toc-text">netty-rpc-provider</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NettyRpcProviderMain"><span class="toc-number">3.1.</span> <span class="toc-text">NettyRpcProviderMain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#application-properties"><span class="toc-number">3.2.</span> <span class="toc-text">application.properties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UserServiceImpl"><span class="toc-number">3.3.</span> <span class="toc-text">UserServiceImpl</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E6%B3%A8%E8%A7%A3%E9%A9%B1%E5%8A%A8"><span class="toc-number">4.</span> <span class="toc-text">修改客户端的注解驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B3%A8%E8%A7%A3"><span class="toc-number">4.1.</span> <span class="toc-text">增加客户端注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringRpcReferenceBean"><span class="toc-number">4.2.</span> <span class="toc-text">SpringRpcReferenceBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringRpcReferencePostProcessor"><span class="toc-number">4.3.</span> <span class="toc-text">SpringRpcReferencePostProcessor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RpcClientProperties"><span class="toc-number">4.4.</span> <span class="toc-text">RpcClientProperties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RpcRefernceAutoConfiguration"><span class="toc-number">4.5.</span> <span class="toc-text">RpcRefernceAutoConfiguration</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#netty-rpc-consumer"><span class="toc-number">5.</span> <span class="toc-text">netty-rpc-consumer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5jar%E5%8C%85%E4%BE%9D%E8%B5%96"><span class="toc-number">5.1.</span> <span class="toc-text">引入jar包依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HelloController"><span class="toc-number">5.2.</span> <span class="toc-text">HelloController</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NettyConsumerMain"><span class="toc-number">5.3.</span> <span class="toc-text">NettyConsumerMain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#application-properties-1"><span class="toc-number">5.4.</span> <span class="toc-text">application.properties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">5.5.</span> <span class="toc-text">访问测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">6.</span> <span class="toc-text">引入注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IRegistryService"><span class="toc-number">6.1.</span> <span class="toc-text">IRegistryService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceInfo"><span class="toc-number">6.2.</span> <span class="toc-text">ServiceInfo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZookeeperRegistryService"><span class="toc-number">6.3.</span> <span class="toc-text">ZookeeperRegistryService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">6.4.</span> <span class="toc-text">引入负载均衡算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ILoadBalance"><span class="toc-number">6.4.1.</span> <span class="toc-text">ILoadBalance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractLoadBalance"><span class="toc-number">6.4.2.</span> <span class="toc-text">AbstractLoadBalance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RandomLoadBalance"><span class="toc-number">6.4.3.</span> <span class="toc-text">RandomLoadBalance</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RegistryType"><span class="toc-number">6.5.</span> <span class="toc-text">RegistryType</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RegistryFactory"><span class="toc-number">6.6.</span> <span class="toc-text">RegistryFactory</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A2%9E%E5%8A%A0%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">7.</span> <span class="toc-text">修改服务端增加服务注册</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringRpcProviderBean-1"><span class="toc-number">7.1.</span> <span class="toc-text">SpringRpcProviderBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RpcServerProperties-1"><span class="toc-number">7.2.</span> <span class="toc-text">RpcServerProperties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RpcProviderAutoConfiguration-1"><span class="toc-number">7.3.</span> <span class="toc-text">RpcProviderAutoConfiguration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#application-properties-2"><span class="toc-number">7.4.</span> <span class="toc-text">application.properties</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8C%E5%A2%9E%E5%8A%A0%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">8.</span> <span class="toc-text">修改客户端，增加服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RpcClientProperties-1"><span class="toc-number">8.1.</span> <span class="toc-text">RpcClientProperties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9NettyClient"><span class="toc-number">8.2.</span> <span class="toc-text">修改NettyClient</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9RpcInvokerProxy"><span class="toc-number">8.3.</span> <span class="toc-text">修改RpcInvokerProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringRpcReferenceBean-1"><span class="toc-number">8.4.</span> <span class="toc-text">SpringRpcReferenceBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringRpcReferencePostProcessor-1"><span class="toc-number">8.5.</span> <span class="toc-text">SpringRpcReferencePostProcessor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RpcRefernceAutoConfiguration-1"><span class="toc-number">8.6.</span> <span class="toc-text">RpcRefernceAutoConfiguration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#application-properties-3"><span class="toc-number">8.7.</span> <span class="toc-text">application.properties</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%B5%8B%E8%AF%95"><span class="toc-number">9.</span> <span class="toc-text">负载均衡的测试</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Mic带你学架构</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'UfKaUFGlfGSkWdJW13mj0MLR-gzGzoHsz',
      appKey: 'FPoX22rGnNq9VlLujWHlxBwc',
      placeholder: '请留下你的足迹，记得写昵称和邮箱...可以快速收到回复',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>